

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Cluster Deployment &mdash; Faros  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  

  
  

  
    <link rel="canonical" href="faros.dev/deploy.html" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Cluster Persistent Storage" href="storage.html" />
    <link rel="prev" title="Cluster Configuration" href="configuration.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #19647E" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/logo_name_white.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Cluster Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Faros Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Cluster Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cluster Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#deploy-the-cluster">Deploy the cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#observing-installation-progress">Observing Installation Progress</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-application-nodes-to-the-cluster">Adding Application Nodes to the Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#public-dns-records">Public DNS records</a></li>
<li class="toctree-l2"><a class="reference internal" href="#connecting-to-the-cluster">Connecting to the cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="#node-auth-certificates">Node auth certificates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#debugging-deployment">Debugging deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#restarting-deployment">Restarting deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Cluster Persistent Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="nvidia.html">NVIDIA Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="operate.html">Day 2 Cluster Operation</a></li>
<li class="toctree-l1"><a class="reference internal" href="example.html">Verified Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="farosctl.html">farosctl Usage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://faros.dev">repos</a></li>
<li class="toctree-l1"><a class="reference external" href="https://faros.dev">devenv</a></li>
<li class="toctree-l1"><a class="reference external" href="https://faros.dev">ansiblefacts</a></li>
<li class="toctree-l1"><a class="reference external" href="https://faros.dev">deploys</a></li>
<li class="toctree-l1"><a class="reference external" href="https://faros.dev">docs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/project-faros/cluster-manager/projects/1">Roadmap</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/project-faros/cluster-manager/issues">Bug Report</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/project-faros">GitHub</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Faros</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          



















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Cluster Deployment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <!-- User defined GitHub URL -->
              <a href="https://github.com/project-faros/faros.dev/blob/master/source/deploy.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="cluster-deployment">
<h1>Cluster Deployment<a class="headerlink" href="#cluster-deployment" title="Permalink to this headline">¶</a></h1>
<p>Now that the hardware has been wired and the cluster has been configured, the
cluster can be deployed.</p>
<section id="deploy-the-cluster">
<h2>Deploy the cluster<a class="headerlink" href="#deploy-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>Run the following command as your administrative user (Not root). During the
deployment process, you will first be prompted to connect the cluster node out
of band management links. You will then be prompted to verify the firmware
configuration of each node.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl install-plan cluster
</pre></div>
</div>
<p><em>Voila!</em></p>
<p>This install plan is the equivalent to running all of the following commands.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply configuration to the router components.</span>
<span class="c1">#   - Gateway, Firewall, DNS, DHCP, and NTP</span>
farosctl apply router

<span class="c1"># Create necessary virtual machines. Currently just the bootstrap.</span>
farosctl create machines

<span class="c1"># Configue cluster nodes in network services.</span>
<span class="c1">#   - DNS, DHCP, and Cockpit</span>
farosctl apply host-records

<span class="c1">#</span>
<span class="c1"># It is now safe to connect the management interfaces to the network</span>
<span class="c1">#</span>

<span class="c1"># Wait for maangement interfaces to become available.</span>
farosctl wait-for management-interfaces

<span class="c1"># Wait for firmware settings to be verified.</span>
farosctl wait-for firmware-config

<span class="c1"># Create the cluster load balancer.</span>
farosctl create load-balancer

<span class="c1"># Create the installation sources and machine config repositories.</span>
farosctl create install-repos

<span class="c1"># Create the OpenShift cluster.</span>
<span class="c1"># This will boot all of the cluster nodes, install Red Hat CoreOS on each</span>
<span class="c1"># node, and install OpenShift.</span>
farosctl create cluster
</pre></div>
</div>
</section>
<section id="observing-installation-progress">
<h2>Observing Installation Progress<a class="headerlink" href="#observing-installation-progress" title="Permalink to this headline">¶</a></h2>
<p>During the install process, the current action being taken is printed to the
screen. However, once the OpenShift cluster begins bootstrapping and
installing, the actions become long running and dont provide much feedback.
During these phases, it is possible to get a detailed status of the progress
being made on the install.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>watch farosctl get cluster-upgrade-status
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The status percentage at the top of this display will routinely report
nuisance errors during cluster installation. These may be safely ignored. If
the install process itself reports an error, that should be observed.</p>
</div>
</section>
<section id="adding-application-nodes-to-the-cluster">
<h2>Adding Application Nodes to the Cluster<a class="headerlink" href="#adding-application-nodes-to-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>Once the first step of the install has completed and the cluster control plane
is available, the application nodes can be added to the cluster. To do this run
the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl apply app-nodes
</pre></div>
</div>
</section>
<section id="public-dns-records">
<h2>Public DNS records<a class="headerlink" href="#public-dns-records" title="Permalink to this headline">¶</a></h2>
<p>This step is not required, but will usually be desired. If you would like to
reach the cluster from an external machine, you will need to create a few
public DNS records. The content of the records will be slightly difference
depending on the gatway routing method used (NAT or PAT). Use the following
command to determine what your records should be:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl get public-dns-records
</pre></div>
</div>
<p>For a NATed network, you will get output like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>; Public DNS records for faros.site zone.
bastion.edge.example.com.   IN  A   192.168.5.16
api.edge.example.com.       IN  A   192.168.8.2
*.apps.edge.example.com.    IN  A   192.168.8.2
</pre></div>
</div>
<p>For a PATed network, you will get output like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>; Public DNS records for faros.site zone.
bastion.edge.example.com.   IN  A   192.168.5.16
api.edge.example.com.       IN  A   192.168.5.16
*.apps.edge.example.com.    IN  A   192.168.5.16
</pre></div>
</div>
</section>
<section id="connecting-to-the-cluster">
<h2>Connecting to the cluster<a class="headerlink" href="#connecting-to-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>The cluster credentials are displayed at the end of the cluster deployment
process. If you need to retreive them again, use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl get credentials
</pre></div>
</div>
<p>This will return the cluster API domain, the cluster console domain, and the
kubeadmin password in a human readable format.</p>
<p>The following command will give you the login information in the form of an <cite>oc
login</cite> command. Run this command and then execute the string it returns to
quickly login to the cluster as kubeadmin.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/bin/bash -c <span class="k">$(</span>farosctl get oc-login<span class="k">)</span>
</pre></div>
</div>
</section>
<section id="node-auth-certificates">
<h2>Node auth certificates<a class="headerlink" href="#node-auth-certificates" title="Permalink to this headline">¶</a></h2>
<p>Kubernetes uses OpenSSL certificates for internode authentication. The initial
set of these certificates are only valid for 24 hours. At that point, they are
automatically rotated by the cluster. Every subsequent set of certificates is
valid for 30 days. To avoid issues, do not shutdown the cluster in the first 24
hours. After that, do not leave the cluster powered off for longer than 30
days.</p>
</section>
<section id="debugging-deployment">
<h2>Debugging deployment<a class="headerlink" href="#debugging-deployment" title="Permalink to this headline">¶</a></h2>
<p>If issues are encountered during the cluster deployment process, add a <cite>-v</cite>
flag to the <cite>farosctl</cite> command for increased verbosity. Adding more v’s will
increase the verbosity futher.</p>
<p>If the installlation times out waiting for the cluster nodes to start
provisioning, connect to the nodes’ management interfaces and ensure they have
PXE booted. This is typically indicative of the boot order not being properly
set. If the nodes are failing to PXE boot, ensure that their MAC address has
been properly set in the <cite>farosctl config</cite> interface. The syslog on the bastion
node is also a good source for verifying MAC addresses while they are DHCP
booting.</p>
<p>If the nodes have PXE booted and CoreOS has been installed, watch the
nodes’ consoles as they boot for errors. If there are errors about certificate
verification errors, either the cluster’s bootstrap CA hs expired of the
system’s hardware clock is wrong. Veryify the hardware clock in the system’s
settings. To generate a noot boostrap CA certificate, recreate the install
repos.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl create install-repos
</pre></div>
</div>
<p>If the installation times out waiting for the bootstrapping to complete, the
bootstrap node will likely have the most informative logs. To get the bootstrap
logs, ssh to the bootstrap node and monitor the bootkube service.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl ssh bootstrap
journalctl -b -f -u bootkube.service
</pre></div>
</div>
<p>If the installer times out waiting for the cluster install to complete, you
will need to log into the cluster and determine which services were unable to
come up healthy.</p>
</section>
<section id="restarting-deployment">
<h2>Restarting deployment<a class="headerlink" href="#restarting-deployment" title="Permalink to this headline">¶</a></h2>
<p>After a failed cluster deployment, the deployment can be easily restarted
without starting over. First, fix the issue that caused the deployment to fail.
If a change to the cluster configuration was required, first re-apply the
configuration settings.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl apply
</pre></div>
</div>
<p>Then, regenerate the ignition files and CA certificates used for the
deployment.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl create install-repos
</pre></div>
</div>
<p>Finally, restart the cluster deployment.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>farosctl create cluster
</pre></div>
</div>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="storage.html" class="btn btn-neutral float-right" title="Cluster Persistent Storage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="configuration.html" class="btn btn-neutral float-left" title="Cluster Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Project Faros Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>